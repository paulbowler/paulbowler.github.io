<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Functional Adventures]]></title>
  <link href="http://paulbowler.github.io/atom.xml" rel="self"/>
  <link href="http://paulbowler.github.io/"/>
  <updated>2013-10-24T14:47:02+01:00</updated>
  <id>http://paulbowler.github.io/</id>
  <author>
    <name><![CDATA[Paul Bowler]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Sorting maps by multiple keys in Clojure]]></title>
    <link href="http://paulbowler.github.io/blog/2013/10/24/sorting-maps-by-multiple-keys-in-clojure/"/>
    <updated>2013-10-24T11:34:00+01:00</updated>
    <id>http://paulbowler.github.io/blog/2013/10/24/sorting-maps-by-multiple-keys-in-clojure</id>
    <content type="html"><![CDATA[<p>Several hundred school students have taken an exam and the Headmistress wants a list of results ordered by score. Pretty simple ask.</p>

<p>Here is a representative sample of the students, their age and score as a sequence of maps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">results</span> <span class="p">[{</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span> <span class="ss">:age</span> <span class="mi">10</span> <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'>              <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>  <span class="ss">:age</span> <span class="mi">15</span> <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'>              <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span> <span class="ss">:age</span> <span class="mi">15</span> <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'>              <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span> <span class="ss">:age</span> <span class="mi">7</span>  <span class="ss">:score</span> <span class="mi">7</span><span class="p">}</span>
</span><span class='line'>              <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span> <span class="ss">:age</span> <span class="mi">9</span>  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>


<p>As keywords are also Clojure functions, it is very simple to sort maps by a specific key:</p>

<figure class='code'><figcaption><span>Sorting map by single key</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">results</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span>, <span class="ss">:age</span> <span class="mi">7</span>,  <span class="ss">:score</span> <span class="mi">7</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>,  <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span>, <span class="ss">:age</span> <span class="mi">9</span>,  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span>, <span class="ss">:age</span> <span class="mi">10</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span>, <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is fine, although the scores are in lowest-first order. We can fix that by reversing the sequence:</p>

<figure class='code'><figcaption><span>Reversing the order of results</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">sort-by </span><span class="ss">:score</span> <span class="nv">results</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span>, <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span>, <span class="ss">:age</span> <span class="mi">10</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span>, <span class="ss">:age</span> <span class="mi">9</span>,  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>,  <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span>, <span class="ss">:age</span> <span class="mi">7</span>,  <span class="ss">:score</span> <span class="mi">7</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The headmistress is happy, although now she also wants the results weighted by age so that of students with
equal marks the younger will come above the older.</p>

<p>To do this we need to be able to sort by multiple keys such as you would in a relational database using &lsquo;order by score, age&rsquo;. In clojure we can&rsquo;t just do this by adding the second keyword to sort-by. Instead, what we need is to be able to apply each sort in turn. Looking through the docs it appears that <a href="http://clojuredocs.org/clojure_core/clojure.core/juxt">juxt</a> does exactly what we need:</p>

<blockquote><p>Takes a set of functions and returns a fn that is the juxtaposition<br/>of those fns. The returned fn takes a variable number of args, and<br/>returns a vector containing the result of applying each fn to the<br/>args (left-to-right).</p></blockquote>


<p>Adding in juxt to the code gives:</p>

<figure class='code'><figcaption><span>Sorting map by multiple keys</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nb">sort-by </span><span class="p">(</span><span class="nf">juxt</span> <span class="ss">:score</span> <span class="ss">:age</span><span class="p">)</span> <span class="p">[</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span> <span class="ss">:age</span> <span class="mi">10</span> <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>  <span class="ss">:age</span> <span class="mi">15</span> <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span> <span class="ss">:age</span> <span class="mi">15</span> <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span> <span class="ss">:age</span> <span class="mi">7</span>  <span class="ss">:score</span> <span class="mi">7</span><span class="p">}</span>
</span><span class='line'>             <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span> <span class="ss">:age</span> <span class="mi">9</span>  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}])</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span>, <span class="ss">:age</span> <span class="mi">7</span>,  <span class="ss">:score</span> <span class="mi">7</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span>, <span class="ss">:age</span> <span class="mi">9</span>,  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>,  <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span>, <span class="ss">:age</span> <span class="mi">10</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span>, <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately we now have both age and score going from lowest to highest. We need score ranking from highest to lowest again as we had in the previous example. To use the SQL example again, we need &lsquo;order by score <em>desc</em>, age&rsquo;. Clearly this time we can&rsquo;t just reverse the resulting sequence as student&rsquo;s ages would then be in the wrong order. Hmmm&hellip;</p>

<p>Under the covers Clojure sorts integers using a comparison of two values. This returns -1 for &lsquo;a &lt; b&rsquo;, 0 for &lsquo;a = b&rsquo; or +1 for &lsquo;a > c&rsquo;. It can then use a sort algorithm to put them all in the correct place. The comparison function itself is written in the base class, in this instance &lsquo;Integer&rsquo; which implements the &lsquo;Comparable&rsquo; interface through a &lsquo;compareTo&rsquo; method.</p>

<p>We cannot overide Integer&rsquo;s &lsquo;compareTo&rsquo; method, so we have to find other creative ways. One way is to change the value to a negative by wrapping the map &lsquo;get&rsquo; function (which is effectively what the keyword does as a function) and performing the transformation there. The scores can then be sorted in the correct order as before:</p>

<figure class='code'><figcaption><span>Reversing the score order</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">(</span><span class="nb">sort-by </span><span class="p">(</span><span class="nf">juxt</span> <span class="o">#</span><span class="p">(</span><span class="nb">* </span><span class="mi">-1</span> <span class="p">(</span><span class="ss">:score</span> <span class="nv">%</span><span class="p">))</span> <span class="ss">:age</span><span class="p">)</span> <span class="nv">results</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gives us exactly what we want:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clj'><span class='line'><span class="p">({</span><span class="ss">:name</span> <span class="s">&quot;Fred&quot;</span>, <span class="ss">:age</span> <span class="mi">10</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Bill&quot;</span>, <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">9</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jane&quot;</span>, <span class="ss">:age</span> <span class="mi">9</span>,  <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Jim&quot;</span>,  <span class="ss">:age</span> <span class="mi">15</span>, <span class="ss">:score</span> <span class="mi">8</span><span class="p">}</span>
</span><span class='line'> <span class="p">{</span><span class="ss">:name</span> <span class="s">&quot;Emma&quot;</span>, <span class="ss">:age</span> <span class="mi">7</span>,  <span class="ss">:score</span> <span class="mi">7</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Headmistress is very please and she can now process the hundreds of test results in no time at all. Result!</p>
]]></content>
  </entry>
  
</feed>
